---
/**
 * HoverPreviewVideo Component
 *
 * Desktop-only MP4 preview that plays on hover.
 * - Shows poster by default
 * - On hover: plays muted, looped video
 * - On mouse leave: pauses and resets to start
 * - Only one preview plays at a time site-wide (via videoPreviewManager)
 * - Mobile: shows poster only, no hover behavior
 *
 * Usage:
 * <HoverPreviewVideo
 *   src="/video/film-preview.mp4"
 *   poster={thumbnailImage}
 *   alt="Film title preview"
 * />
 */
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Props {
    /** Path to the MP4 video file (in public/video/) */
    src: string;
    /** Poster image to show before video plays */
    poster: ImageMetadata;
    /** Alt text for the poster image */
    alt: string;
    /** Optional unique ID for this preview (auto-generated if not provided) */
    previewId?: string;
    /** Optional additional CSS classes */
    class?: string;
}

const { src, poster, alt, previewId, class: className } = Astro.props;

// Generate a unique ID for this preview instance
const uniqueId =
    previewId || `preview-${Math.random().toString(36).substring(2, 9)}`;
---

<div class:list={["hover-preview-video", className]} data-hover-preview>
    <!-- Poster image (always visible, becomes hidden on hover for desktop) -->
    <Image
        src={poster}
        alt={alt}
        class="hover-preview-poster"
        widths={[400, 800, 1200]}
        sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 25vw"
    />

    <!-- Video element (desktop only, hidden until hover) -->
    <video
        class="hover-preview-video-el"
        data-preview-id={uniqueId}
        data-src={src}
        muted
        loop
        playsinline
        preload="none"
    >
        <!-- Source is set dynamically on first hover to minimize preload -->
    </video>
</div>

<style>
    .hover-preview-video {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .hover-preview-poster {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: contain; /* Contain to show full image, no cropping */
        z-index: 1;
        transition: opacity 0.3s ease;
    }

    .hover-preview-video-el {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: contain; /* Contain to show full video, no cropping */
        z-index: 0;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    /* Desktop: show video on hover */
    @media (hover: hover) and (pointer: fine) {
        .hover-preview-video:hover .hover-preview-poster {
            opacity: 0;
        }

        .hover-preview-video:hover .hover-preview-video-el {
            opacity: 1;
        }
    }
</style>

<script>
    import {
        setCurrentlyPlaying,
        clearCurrentlyPlaying,
        pauseAndReset,
    } from "../scripts/videoPreviewManager";

    /**
     * Initialize hover preview behavior for all instances on the page.
     * This runs once when the page loads.
     */
    function initHoverPreviews(): void {
        // Only enable on devices with hover capability (desktop)
        const hasHover = window.matchMedia(
            "(hover: hover) and (pointer: fine)",
        ).matches;
        if (!hasHover) return;

        const containers = document.querySelectorAll<HTMLElement>(
            "[data-hover-preview]",
        );

        containers.forEach((container) => {
            const video = container.querySelector<HTMLVideoElement>(
                ".hover-preview-video-el",
            );
            if (!video) return;

            let isLoaded = false;

            // Mouse enter: load source (if needed) and play
            container.addEventListener("mouseenter", async () => {
                // Lazy load the video source on first hover
                if (!isLoaded && video.dataset.src) {
                    video.src = video.dataset.src;
                    isLoaded = true;

                    // Wait for video to be ready
                    await new Promise<void>((resolve) => {
                        video.addEventListener("canplay", () => resolve(), {
                            once: true,
                        });
                        video.load();
                    });
                }

                // Register as currently playing (pauses others)
                setCurrentlyPlaying(video);

                // Play the video
                try {
                    await video.play();
                } catch (err) {
                    // Autoplay may be blocked, that's fine
                    console.debug("Video autoplay prevented:", err);
                }
            });

            // Mouse leave: pause and reset
            container.addEventListener("mouseleave", () => {
                pauseAndReset(video);
                clearCurrentlyPlaying(video);
            });
        });
    }

    // Initialize on DOM ready
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initHoverPreviews);
    } else {
        initHoverPreviews();
    }

    // Re-initialize on Astro page transitions (View Transitions)
    document.addEventListener("astro:page-load", initHoverPreviews);
</script>
