---
/**
 * FilmTile Component
 *
 * Tim Flower-style tile for the film index mosaic.
 * - Brutalist/minimalist dark mode aesthetic
 * - Gap masking technique for shared borders
 * - Index number + Title (left) + Type/Year (right)
 * - Full-bleed thumbnail with object-fit: cover
 * - Desktop: hover preview video when available
 * - Mobile: poster/thumbnail only
 */
import { Image } from "astro:assets";
import { getImage } from "../lib/images";
import HoverPreviewVideo from "./HoverPreviewVideo.astro";
import type { Film } from "../content.config";

interface Props {
    film: {
        data: Film;
    };
    displayIndex: string;
    tileSize: "small" | "wide" | "large";
}

const { film, displayIndex, tileSize } = Astro.props;

// Get thumbnail image if available
const thumbnail = film.data.thumbnailKey
    ? getImage(film.data.thumbnailKey)
    : null;

// Check if we have a preview video
const hasPreviewVideo = !!film.data.previewMp4;

// Grid span classes based on tile size
// Apply at sm breakpoint so mobile stays single-column
const sizeClasses = {
    small: "",
    wide: "sm:col-span-2",
    large: "sm:col-span-2 sm:row-span-2",
};

// Extract year from date
const year = film.data.date ? new Date(film.data.date).getFullYear() : null;
---

<a
    href={`/film/${film.data.slug}`}
    class:list={["film-tile group", sizeClasses[tileSize]]}
>
    <!-- Header inside the box -->
    <div class="film-tile__header">
        <span class="film-tile__index">{displayIndex}</span>
        <span class="film-tile__title" data-glitch-text
            >{film.data.title.toUpperCase()}</span
        >
        <span class="film-tile__duration">
            {film.data.duration ? film.data.duration : ""}
        </span>
    </div>

    <!-- Media Container -->
    <div class="film-tile__media">
        {
            /* If we have both thumbnail and preview video, use HoverPreviewVideo */
            hasPreviewVideo && thumbnail ? (
                <HoverPreviewVideo
                    src={film.data.previewMp4!}
                    poster={thumbnail}
                    alt={film.data.title}
                    previewId={`film-${film.data.slug}`}
                />
            ) : thumbnail ? (
                /* Fallback to static image if no preview video */
                <Image
                    src={thumbnail}
                    alt={film.data.title}
                    class="film-tile-img"
                    widths={[400, 800, 1200]}
                    sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 25vw"
                />
            ) : (
                /* Placeholder if no thumbnail at all */
                <div class="film-tile-placeholder">
                    <span>{film.data.type}</span>
                </div>
            )
        }
    </div>

    <!-- Hidden metadata for potential future use or screen readers, though title is in header now -->
    <span class="sr-only">{film.data.type} {year}</span>
</a>

<style>
    /* =========================================
       FILM TILE - Matches WorkCard Aesthetic
       ========================================= */

    .film-tile {
        position: relative;
        display: flex;
        flex-direction: column;

        /* Overlap borders to ensure 1px visual width */
        width: calc(100% + 1px);
        height: calc(100% + 1px);
        margin: -1px 0 0 -1px; /* Pull left and up to overlap previous items */

        background-color: transparent;
        overflow: hidden;
        padding: 10px; /* Inset content by 10px */
        cursor: pointer;

        /* Broken Grid Borders: White lines that don't touch at corners */
        background-image:
            linear-gradient(to right, white, white),
            /* Top */ linear-gradient(to bottom, white, white),
            /* Right */ linear-gradient(to left, white, white),
            /* Bottom */ linear-gradient(to top, white, white); /* Left */

        background-size:
            calc(100% - 24px) 1px,
            /* Top: width - gaps, 1px height */ 1px calc(100% - 24px),
            /* Right: 1px width, height - gaps */ calc(100% - 24px) 1px,
            /* Bottom: width - gaps, 1px height */ 1px calc(100% - 24px); /* Left: 1px width, height - gaps */

        background-position:
            center top,
            right center,
            center bottom,
            left center;

        background-repeat: no-repeat;
    }

    /* Header */
    .film-tile__header {
        flex-shrink: 0;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 0.75rem 1rem;
        background-color: transparent;
        z-index: 10;
    }

    .film-tile__index {
        font-family: monospace;
        font-size: 0.75rem; /* text-xs */
        color: #71717a; /* zinc-500 */
        justify-self: start;
    }

    .film-tile__duration {
        font-family: monospace;
        font-size: 0.75rem; /* text-xs */
        color: #71717a; /* zinc-500 */
        justify-self: end;
        text-align: right;
    }

    .film-tile__title {
        font-size: 0.75rem; /* text-xs */
        font-weight: 500;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Media container - full bleed within the padding */
    .film-tile__media {
        flex: 1;
        position: relative;
        width: 100%;
        min-height: 0;
        background: transparent;
        overflow: hidden;
    }

    /* Target images/video deep inside */
    .film-tile__media :global(img),
    .film-tile__media :global(video) {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition:
            filter 0.5s ease,
            transform 0.5s ease;
    }

    /* Hover effects */
    .film-tile:hover .film-tile__media :global(img),
    .film-tile:hover .film-tile__media :global(video) {
        transform: scale(1.02);
        filter: brightness(1.05);
    }

    /* Placeholder for missing thumbnails */
    .film-tile-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.03);
    }

    .film-tile-placeholder span {
        font-size: 0.65rem;
        font-weight: 500;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.25);
    }
</style>

<script>
    import { createGlitchWave } from "../scripts/scramble";

    function setupFilmTiles() {
        const tiles = document.querySelectorAll(".film-tile");

        tiles.forEach((tile) => {
            // Avoid double binding
            if (tile.hasAttribute("data-glitch-bound")) return;

            const title = tile.querySelector<HTMLElement>("[data-glitch-text]");
            if (!title) return;

            const originalText = title.textContent || "";
            let stopWave: (() => void) | null = null;

            tile.addEventListener("mouseenter", () => {
                if (stopWave) stopWave();
                stopWave = createGlitchWave(title, originalText);
            });

            tile.addEventListener("mouseleave", () => {
                if (stopWave) {
                    stopWave();
                    stopWave = null;
                }
            });

            tile.setAttribute("data-glitch-bound", "true");
        });
    }

    // Initial load
    setupFilmTiles();

    // View transitions
    document.addEventListener("astro:page-load", setupFilmTiles);
</script>
